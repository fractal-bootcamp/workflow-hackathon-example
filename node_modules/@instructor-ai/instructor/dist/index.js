import g from"openai";import{Stream as b}from"openai/streaming";import{ZodError as v}from"zod";import _,{OAIResponseParser as L,OAIStream as y,withResponseModel as w}from"zod-stream";import{fromZodError as x}from"zod-validation-error";function T(i,e){let t={};for(let n in e)e.hasOwnProperty(n)&&!i.includes(n)&&(t[n]=e[n]);return t}async function P(i,e){let t=Array.from({length:e},()=>[]),n=[],p=i[Symbol.asyncIterator](),a=!1;async function*l(d){for(;;)if(t[d].length>0)yield t[d].shift();else{if(a)break;await new Promise(h=>n.push(h))}}return(async()=>{for await(let d of{[Symbol.asyncIterator]:()=>p}){for(let h of t)h.push(d);for(;n.length>0;)n.shift()()}for(a=!0;n.length>0;)n.shift()()})(),Array.from({length:e},(d,h)=>l(h))}import{MODE as N}from"zod-stream";var o=N,r={OAI:"OAI",ANYSCALE:"ANYSCALE",TOGETHER:"TOGETHER",ANTHROPIC:"ANTHROPIC",GROQ:"GROQ",OTHER:"OTHER"},E={[r.OTHER]:[o.FUNCTIONS,o.TOOLS,o.JSON,o.JSON_SCHEMA,o.MD_JSON],[r.OAI]:[o.FUNCTIONS,o.TOOLS,o.JSON,o.MD_JSON],[r.ANYSCALE]:[o.TOOLS,o.JSON,o.JSON_SCHEMA,o.MD_JSON],[r.TOGETHER]:[o.TOOLS,o.JSON,o.JSON_SCHEMA,o.MD_JSON],[r.ANTHROPIC]:[o.MD_JSON,o.TOOLS],[r.GROQ]:[o.TOOLS,o.FUNCTIONS,o.MD_JSON]},C={[r.ANYSCALE]:"api.endpoints.anyscale",[r.TOGETHER]:"api.together.xyz",[r.OAI]:"api.openai.com",[r.ANTHROPIC]:"api.anthropic.com",[r.GROQ]:"api.groq.com"},S={[r.GROQ]:{[o.TOOLS]:function(e){return e.tools.some(t=>t)&&e.stream&&console.warn("Streaming may not be supported when using tools in Groq, try MD_JSON instead"),e}},[r.ANYSCALE]:{[o.JSON_SCHEMA]:function(e){return"additionalProperties"in e.response_format.schema?{...e,response_format:{...e.response_format,schema:T(["additionalProperties"],e.response_format.schema)}}:e},[o.TOOLS]:function(e){return e.tools.some(t=>t.function?.parameters)?{...e,tools:e.tools.map(t=>t.function?.parameters?{...t,function:{...t.function,parameters:T(["additionalProperties"],t.function.parameters)}}:t)}:e}}},M={[r.OTHER]:{[o.FUNCTIONS]:["*"],[o.TOOLS]:["*"],[o.JSON]:["*"],[o.MD_JSON]:["*"],[o.JSON_SCHEMA]:["*"]},[r.OAI]:{[o.FUNCTIONS]:["*"],[o.TOOLS]:["*"],[o.JSON]:["*"],[o.MD_JSON]:["*"]},[r.TOGETHER]:{[o.MD_JSON]:["*"],[o.JSON_SCHEMA]:["mistralai/Mixtral-8x7B-Instruct-v0.1","mistralai/Mistral-7B-Instruct-v0.1","togethercomputer/CodeLlama-34b-Instruct"],[o.TOOLS]:["mistralai/Mixtral-8x7B-Instruct-v0.1","mistralai/Mistral-7B-Instruct-v0.1","togethercomputer/CodeLlama-34b-Instruct"]},[r.ANYSCALE]:{[o.MD_JSON]:["*"],[o.JSON_SCHEMA]:["mistralai/Mistral-7B-Instruct-v0.1","mistralai/Mixtral-8x7B-Instruct-v0.1"],[o.TOOLS]:["mistralai/Mistral-7B-Instruct-v0.1","mistralai/Mixtral-8x7B-Instruct-v0.1"]},[r.ANTHROPIC]:{[o.MD_JSON]:["*"],[o.TOOLS]:["*"]},[r.GROQ]:{[o.TOOLS]:["mixtral-8x7b-32768","gemma-7b-it"],[o.MD_JSON]:["*"]}};var D=0,A=class{constructor({client:e,mode:t,debug:n=!1,logger:p=void 0,retryAllErrors:a=!1}){this.debug=!1;this.retryAllErrors=!1;this.chat={completions:{create:async(e,t)=>{if(this.validateModelModeSupport(e),this.isChatCompletionCreateParamsWithModel(e))return e.stream?this.chatCompletionStream(e,t):this.chatCompletionStandard(e,t);if(this.client.chat?.completions?.create)return this.isStandardStream(e)?await this.client.chat.completions.create(e,t):await this.client.chat.completions.create(e,t);throw new Error("Completion method is undefined")}}};if(!k(e)&&!(e instanceof g))throw new Error("Client does not match the required structure");e instanceof g?this.client=e:this.client=e,this.mode=t,this.debug=n,this.retryAllErrors=a,this.logger=p??void 0;let l=typeof this.client?.baseURL=="string"?this.client?.baseURL.includes(C.ANYSCALE)?r.ANYSCALE:this.client?.baseURL.includes(C.TOGETHER)?r.TOGETHER:this.client?.baseURL.includes(C.OAI)?r.OAI:this.client?.baseURL.includes(C.ANTHROPIC)?r.ANTHROPIC:r.OTHER:r.OTHER;this.provider=l,this.validateOptions()}validateOptions(){let e=E[this.provider].includes(this.mode);this.provider===r.OTHER&&this.log("debug","Unknown provider - cant validate options."),e||this.log("warn",`Mode ${this.mode} may not be supported by provider ${this.provider}`)}validateModelModeSupport(e){if(this.provider!==r.OAI){let t=M[this.provider][this.mode];if(!t.includes("*")&&!t.includes(e.model))throw new Error(`Model ${e.model} is not supported by provider ${this.provider} in mode ${this.mode}`)}}log(e,...t){if(this.logger&&this.logger(e,...t),!this.debug&&e==="debug")return;let n=new Date().toISOString();switch(e){case"debug":console.debug(`[Instructor:DEBUG] ${n}:`,...t);break;case"info":console.info(`[Instructor:INFO] ${n}:`,...t);break;case"warn":console.warn(`[Instructor:WARN] ${n}:`,...t);break;case"error":console.error(`[Instructor:ERROR] ${n}:`,...t);break}}async chatCompletionStandard({max_retries:e=D,response_model:t,...n},p){let a=0,l="",d=null,h=S?.[this.provider]?.[this.mode],u=w({params:{...n,stream:n.stream??!1},mode:this.mode,response_model:t});h&&(u=h(u));let f=async()=>{let s=u;l?.length>0&&(s={...u,messages:[...u.messages,...d?[d]:[],{role:"user",content:`Please correct the function call; errors encountered:
 ${l}`}]});let c;try{if(this.client.chat?.completions?.create)c=await this.client.chat.completions.create({...s,stream:!1},p);else throw new Error("Unsupported client type -- no completion method found.");this.log("debug","raw standard completion response: ",c)}catch(O){throw this.log("error",`Error making completion call - mode: ${this.mode} | Client base URL: ${this.client.baseURL} | with params:`,s,"raw error",O),O}let I=L(c);try{return{...JSON.parse(I),_meta:{usage:c?.usage??void 0}}}catch(O){throw this.log("error","failed to parse completion",I,this.mode,"attempt: ",a,"max attempts: ",e),O}},m=async()=>{try{let s=await f(),c=await t.schema.safeParseAsync(s);if(this.log("debug",t.name,"Completion validation: ",c),!c.success)throw"error"in c?(d={role:"assistant",content:JSON.stringify(s)},l=x(c.error)?.message,c.error):new Error("Validation failed.");return{...c.data,_meta:s?._meta??{}}}catch(s){if(!this.retryAllErrors&&!(s instanceof v))throw s;if(a<e)return this.log("debug",`response model: ${t.name} - Retrying, attempt: `,a),this.log("warn",`response model: ${t.name} - Validation issues: `,l," - Attempt: ",a," - Max attempts: ",e),a++,await m();throw this.log("debug",`response model: ${t.name} - Max attempts reached: ${a}`),this.log("error",`response model: ${t.name} - Validation issues: `,l),s}};return m()}async*chatCompletionStream({max_retries:e,response_model:t,...n},p){e&&this.log("warn","max_retries is not supported for streaming completions");let a=S?.[this.provider]?.[this.mode],l=w({params:{...n,stream:!0},response_model:t,mode:this.mode});a&&(l=a(l));let d=new _({debug:this.debug??!1});async function h(m){for await(let s of m)"usage"in s&&(u=s.usage)}let u,f=await d.create({completionPromise:async()=>{if(this.client.chat?.completions?.create){let m=await this.client.chat.completions.create({...l,stream:!0},p);if(this.log("debug","raw stream completion response: ",m),this.provider==="OAI"&&l?.stream&&"stream_options"in l&&m instanceof b){let[s,c]=m.tee();return h(s),y({res:c})}if(this.provider!=="OAI"&&l?.stream&&m?.[Symbol.asyncIterator]){let[s,c]=await P(m,2);return h(s),y({res:c})}return y({res:m})}else throw new Error("Unsupported client type")},response_model:t});for await(let m of f)yield{...m,_meta:{usage:u??void 0,...m?._meta??{}}}}isChatCompletionCreateParamsWithModel(e){return"response_model"in e}isStandardStream(e){return"stream"in e&&e.stream===!0}};function R(i){let e=new A(i);return new Proxy(e,{get:(n,p,a)=>p in n?Reflect.get(n,p,a):Reflect.get(n.client,p,a)})}function k(i){return typeof i=="object"&&i!==null&&"baseURL"in i&&"chat"in i&&typeof i.chat=="object"&&"completions"in i.chat&&typeof i.chat.completions=="object"&&"create"in i.chat.completions&&typeof i.chat.completions.create=="function"}var ee=R;export{ee as default};
//# sourceMappingURL=index.js.map