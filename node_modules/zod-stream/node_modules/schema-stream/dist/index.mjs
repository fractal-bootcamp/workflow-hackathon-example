var O=Object.defineProperty;var C=(T,e,i)=>e in T?O(T,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):T[e]=i;var s=(T,e,i)=>(C(T,typeof e!="symbol"?e+"":e,i),i);import{lensPath as U,set as b,view as M}from"ramda";var S=(a=>(a[a.LEFT_BRACE=0]="LEFT_BRACE",a[a.RIGHT_BRACE=1]="RIGHT_BRACE",a[a.LEFT_BRACKET=2]="LEFT_BRACKET",a[a.RIGHT_BRACKET=3]="RIGHT_BRACKET",a[a.COLON=4]="COLON",a[a.COMMA=5]="COMMA",a[a.TRUE=6]="TRUE",a[a.FALSE=7]="FALSE",a[a.NULL=8]="NULL",a[a.STRING=9]="STRING",a[a.NUMBER=10]="NUMBER",a[a.SEPARATOR=11]="SEPARATOR",a))(S||{});var r=S;function l(T){return["VALUE","KEY","COLON","COMMA","ENDED","ERROR","SEPARATOR"][T]}var P={paths:void 0,keepStack:!0,separator:void 0},_=class T extends Error{constructor(e){super(e),Object.setPrototypeOf(this,T.prototype)}},f=class{constructor(e){s(this,"paths");s(this,"keepStack");s(this,"separator");s(this,"state",0);s(this,"mode");s(this,"key");s(this,"value");s(this,"stack",[]);e={...P,...e},e.paths&&(this.paths=e.paths.map(i=>{if(i===void 0||i==="$*")return;if(!i.startsWith("$"))throw new _(`Invalid selector "${i}". Should start with "$".`);let n=i.split(".").slice(1);if(n.includes(""))throw new _(`Invalid selector "${i}". ".." syntax not supported.`);return n})),this.keepStack=!0,this.separator=e.separator}shouldEmit(){return this.paths?this.paths.some(e=>{if(e===void 0)return!0;if(e.length!==this.stack.length)return!1;for(let n=0;n<e.length-1;n++){let t=e[n],o=this.stack[n+1].key;if(t!=="*"&&t!==o)return!1}let i=e[e.length-1];return i==="*"?!0:i===this.key?.toString()}):!0}push(){this.stack.push({key:this.key,value:this.value,mode:this.mode,emit:this.shouldEmit()})}pop(){let e=this.value,i;({key:this.key,value:this.value,mode:this.mode,emit:i}=this.stack.pop()),this.state=this.mode!==void 0?3:0,this.emit(e,i)}emit(e,i){!this.keepStack&&this.value&&this.stack.every(n=>!n.emit)&&delete this.value[this.key],i&&this.onValue({value:e,key:this.key,parent:this.value,stack:this.stack}),this.stack.length===0&&(this.separator?this.state=6:this.separator===void 0&&this.end())}get isEnded(){return this.state===4}write({token:e,value:i,partial:n}){if(!n)try{if(this.state===0){if(e===r.STRING||e===r.NUMBER||e===r.TRUE||e===r.FALSE||e===r.NULL){this.mode===0?(this.value[this.key]=i,this.state=3):this.mode===1&&(this.value.push(i),this.state=3),this.emit(i,this.shouldEmit());return}if(e===r.LEFT_BRACE){if(this.push(),this.mode===0)this.value=this.value[this.key]={};else if(this.mode===1){let t={};this.value.push(t),this.value=t}else this.value={};this.mode=0,this.state=1,this.key=void 0;return}if(e===r.LEFT_BRACKET){if(this.push(),this.mode===0)this.value=this.value[this.key]=[];else if(this.mode===1){let t=[];this.value.push(t),this.value=t}else this.value=[];this.mode=1,this.state=0,this.key=0;return}if(this.mode===1&&e===r.RIGHT_BRACKET&&this.value.length===0){this.pop();return}}if(this.state===1){if(e===r.STRING){this.key=i,this.state=2;return}if(e===r.RIGHT_BRACE&&Object.keys(this.value).length===0){this.pop();return}}if(this.state===2&&e===r.COLON){this.state=0;return}if(this.state===3){if(e===r.COMMA){if(this.mode===1){this.state=0,this.key+=1;return}if(this.mode===0){this.state=1;return}}if(e===r.RIGHT_BRACE&&this.mode===0||e===r.RIGHT_BRACKET&&this.mode===1){this.pop();return}}if(this.state===6&&e===r.SEPARATOR&&i===this.separator){this.state=0;return}throw new _(`Unexpected ${r[e]} (${JSON.stringify(i)}) in state ${l(this.state)}`)}catch(t){this.error(t)}}error(e){this.state!==4&&(this.state=5),this.onError(e)}end(){this.state!==0&&this.state!==6||this.stack.length>0?this.error(new Error(`Parser ended in mid-parsing (state: ${l(this.state)}). Either not all the data was received or the data was invalid.`)):(this.state=4,this.onEnd())}onValue(e){throw new _(`Can't emit data before the "onValue" callback has been set up.`)}onError(e){throw e}onEnd(){}};var A=class{constructor({onIncrementalString:e}){s(this,"decoder",new TextDecoder("utf-8"));s(this,"strings",[]);s(this,"onIncrementalString");s(this,"byteLength",0);this.onIncrementalString=e??void 0}appendChar(e){this.strings.push(String.fromCharCode(e)),this.byteLength+=1,this.update()}appendBuf(e,i=0,n=e.length){this.strings.push(this.decoder.decode(e.subarray(i,n))),this.byteLength+=n-i,this.update()}update(){this.onIncrementalString&&this.onIncrementalString(this.toString())}reset(){this.strings=[],this.byteLength=0}toString(){return this.strings.join("")}},L=class{constructor(e,i){s(this,"decoder",new TextDecoder("utf-8"));s(this,"buffer");s(this,"bufferOffset",0);s(this,"string","");s(this,"onIncrementalString");s(this,"byteLength",0);this.buffer=new Uint8Array(e),this.onIncrementalString=i??void 0}appendChar(e){this.bufferOffset>=this.buffer.length&&this.flushStringBuffer(),this.buffer[this.bufferOffset++]=e,this.byteLength+=1}appendBuf(e,i=0,n=e.length){let t=n-i;this.bufferOffset+t>this.buffer.length&&this.flushStringBuffer(),this.buffer.set(e.subarray(i,n),this.bufferOffset),this.bufferOffset+=t,this.byteLength+=t}flushStringBuffer(){this.string+=this.decoder.decode(this.buffer.subarray(0,this.bufferOffset)),this.bufferOffset=0,this.update()}update(){this.onIncrementalString&&this.onIncrementalString(this.toString())}reset(){this.string="",this.bufferOffset=0,this.byteLength=0}toString(){return this.flushStringBuffer(),this.string}};var N={34:34,92:92,47:47,98:8,102:12,110:10,114:13,116:9};function p(T){return["START","ENDED","ERROR","TRUE1","TRUE2","TRUE3","FALSE1","FALSE2","FALSE3","FALSE4","NULL1","NULL2","NULL3","STRING_DEFAULT","STRING_AFTER_BACKSLASH","STRING_UNICODE_DIGIT_1","STRING_UNICODE_DIGIT_2","STRING_UNICODE_DIGIT_3","STRING_UNICODE_DIGIT_4","STRING_INCOMPLETE_CHAR","NUMBER_AFTER_INITIAL_MINUS","NUMBER_AFTER_INITIAL_ZERO","NUMBER_AFTER_INITIAL_NON_ZERO","NUMBER_AFTER_FULL_STOP","NUMBER_AFTER_DECIMAL","NUMBER_AFTER_E","NUMBER_AFTER_E_AND_SIGN","NUMBER_AFTER_E_AND_DIGIT","SEPARATOR"][T]}var g={stringBufferSize:0,numberBufferSize:0,separator:void 0,handleUnescapedNewLines:!1},d=class T extends Error{constructor(e){super(e),Object.setPrototypeOf(this,T.prototype)}},I=class{constructor(e){s(this,"state",0);s(this,"handleUnescapedNewLines");s(this,"separator");s(this,"separatorBytes");s(this,"separatorIndex",0);s(this,"bufferedString");s(this,"bufferedNumber");s(this,"unicode");s(this,"highSurrogate");s(this,"bytes_remaining",0);s(this,"bytes_in_sequence",0);s(this,"char_split_buffer",new Uint8Array(4));s(this,"encoder",new TextEncoder);s(this,"offset",-1);e={...g,...e};let i=n=>{this.onToken({token:r.STRING,value:n,partial:!0})};this.bufferedString=e?.stringBufferSize&&e.stringBufferSize>0?new L(e.stringBufferSize):new A({onIncrementalString:i}),this.bufferedNumber=e?.numberBufferSize&&e.numberBufferSize>0?new L(e.numberBufferSize,i):new A({}),this.handleUnescapedNewLines=e?.handleUnescapedNewLines??!1,this.separator=e?.separator,this.separatorBytes=e?.separator?this.encoder.encode(e.separator):void 0}get isEnded(){return this.state===1}write(e){try{let i;if(e instanceof Uint8Array)i=e;else if(typeof e=="string")i=this.encoder.encode(e);else if(typeof e=="object"&&"buffer"in e||Array.isArray(e))i=Uint8Array.from(e);else throw new TypeError("Unexpected type. The `write` function only accepts Arrays, TypedArrays and Strings.");for(let n=0;n<i.length;n+=1){let t=i[n];switch(this.state){case 0:if(this.offset+=1,this.separatorBytes&&t===this.separatorBytes[0]){if(this.separatorBytes.length===1){this.state=0,this.onToken({token:r.SEPARATOR,value:this.separator,offset:this.offset+this.separatorBytes.length-1});continue}this.state=28;continue}if(t===32||t===10||t===13||t===9)continue;if(t===123){this.onToken({token:r.LEFT_BRACE,value:"{",offset:this.offset});continue}if(t===125){this.onToken({token:r.RIGHT_BRACE,value:"}",offset:this.offset});continue}if(t===91){this.onToken({token:r.LEFT_BRACKET,value:"[",offset:this.offset});continue}if(t===93){this.onToken({token:r.RIGHT_BRACKET,value:"]",offset:this.offset});continue}if(t===58){this.onToken({token:r.COLON,value:":",offset:this.offset});continue}if(t===44){this.onToken({token:r.COMMA,value:",",offset:this.offset});continue}if(t===116){this.state=3;continue}if(t===102){this.state=6;continue}if(t===110){this.state=10;continue}if(t===34){this.bufferedString.reset(),this.state=13;continue}if(t>=49&&t<=57){this.bufferedNumber.reset(),this.bufferedNumber.appendChar(t),this.state=22;continue}if(t===48){this.bufferedNumber.reset(),this.bufferedNumber.appendChar(t),this.state=21;continue}if(t===45){this.bufferedNumber.reset(),this.bufferedNumber.appendChar(t),this.state=20;continue}break;case 13:if(this.handleUnescapedNewLines&&t===10){this.bufferedString.appendChar(92),this.bufferedString.appendChar(110);continue}if(t===34){let o=this.bufferedString.toString();this.state=0,this.onToken({token:r.STRING,value:o,offset:this.offset}),this.offset+=this.bufferedString.byteLength+1;continue}if(t===92){this.state=14;continue}if(t>=128){if(t>=194&&t<=223?this.bytes_in_sequence=2:t<=239?this.bytes_in_sequence=3:this.bytes_in_sequence=4,this.bytes_in_sequence<=i.length-n){this.bufferedString.appendBuf(i,n,n+this.bytes_in_sequence),n+=this.bytes_in_sequence-1;continue}this.bytes_remaining=n+this.bytes_in_sequence-i.length,this.char_split_buffer.set(i.subarray(n)),n=i.length-1,this.state=19;continue}if(t>=32){this.bufferedString.appendChar(t);continue}break;case 19:this.char_split_buffer.set(i.subarray(n,n+this.bytes_remaining),this.bytes_in_sequence-this.bytes_remaining),this.bufferedString.appendBuf(this.char_split_buffer,0,this.bytes_in_sequence),n=this.bytes_remaining-1,this.state=13;continue;case 14:if(N?.[t]){this.bufferedString.appendChar(N[t]),this.state=13;continue}if(t===117){this.unicode="",this.state=15;continue}break;case 15:case 16:case 17:if(t>=48&&t<=57||t>=65&&t<=70||t>=97&&t<=102){this.unicode+=String.fromCharCode(t),this.state+=1;continue}break;case 18:if(t>=48&&t<=57||t>=65&&t<=70||t>=97&&t<=102){let o=parseInt(this.unicode+String.fromCharCode(t),16);this.highSurrogate===void 0?o>=55296&&o<=56319?this.highSurrogate=o:this.bufferedString.appendBuf(this.encoder.encode(String.fromCharCode(o))):(o>=56320&&o<=57343?this.bufferedString.appendBuf(this.encoder.encode(String.fromCharCode(this.highSurrogate,o))):this.bufferedString.appendBuf(this.encoder.encode(String.fromCharCode(this.highSurrogate))),this.highSurrogate=void 0),this.state=13;continue}break;case 20:if(t===48){this.bufferedNumber.appendChar(t),this.state=21;continue}if(t>=49&&t<=57){this.bufferedNumber.appendChar(t),this.state=22;continue}break;case 21:if(t===46){this.bufferedNumber.appendChar(t),this.state=23;continue}if(t===101||t===69){this.bufferedNumber.appendChar(t),this.state=25;continue}n-=1,this.state=0,this.emitNumber();continue;case 22:if(t>=48&&t<=57){this.bufferedNumber.appendChar(t);continue}if(t===46){this.bufferedNumber.appendChar(t),this.state=23;continue}if(t===101||t===69){this.bufferedNumber.appendChar(t),this.state=25;continue}n-=1,this.state=0,this.emitNumber();continue;case 23:if(t>=48&&t<=57){this.bufferedNumber.appendChar(t),this.state=24;continue}break;case 24:if(t>=48&&t<=57){this.bufferedNumber.appendChar(t);continue}if(t===101||t===69){this.bufferedNumber.appendChar(t),this.state=25;continue}n-=1,this.state=0,this.emitNumber();continue;case 25:if(t===43||t===45){this.bufferedNumber.appendChar(t),this.state=26;continue}case 26:if(t>=48&&t<=57){this.bufferedNumber.appendChar(t),this.state=27;continue}break;case 27:if(t>=48&&t<=57){this.bufferedNumber.appendChar(t);continue}n-=1,this.state=0,this.emitNumber();continue;case 3:if(t===114){this.state=4;continue}break;case 4:if(t===117){this.state=5;continue}break;case 5:if(t===101){this.state=0,this.onToken({token:r.TRUE,value:!0,offset:this.offset}),this.offset+=3;continue}break;case 6:if(t===97){this.state=7;continue}break;case 7:if(t===108){this.state=8;continue}break;case 8:if(t===115){this.state=9;continue}break;case 9:if(t===101){this.state=0,this.onToken({token:r.FALSE,value:!1,offset:this.offset}),this.offset+=4;continue}break;case 10:if(t===117){this.state=11;continue}break;case 11:if(t===108){this.state=12;continue}break;case 12:if(t===108){this.state=0,this.onToken({token:r.NULL,value:null,offset:this.offset}),this.offset+=3;continue}break;case 28:if(this.separatorIndex+=1,!this.separatorBytes||t!==this.separatorBytes[this.separatorIndex])break;this.separatorIndex===this.separatorBytes.length-1&&(this.state=0,this.onToken({token:r.SEPARATOR,value:this.separator,offset:this.offset+this.separatorIndex}),this.separatorIndex=0);continue;case 1:if(t===32||t===10||t===13||t===9)continue}throw new d(`Unexpected "${String.fromCharCode(t)}" at position "${n}" in state ${p(this.state)}`)}}catch(i){this.error(i)}}emitNumber(){this.onToken({token:r.NUMBER,value:this.parseNumber(this.bufferedNumber.toString()),offset:this.offset}),this.offset+=this.bufferedNumber.byteLength-1}parseNumber(e){return Number(e)}error(e){this.state!==1&&(this.state=2),this.onError(e)}end(){switch(this.state){case 21:case 22:case 24:case 27:this.state=1,this.emitNumber(),this.onEnd();break;case 0:case 2:case 28:this.state=1,this.onEnd();break;default:this.error(new d(`Tokenizer ended in the middle of a token (state: ${p(this.state)}). Either not all the data was received or the data was invalid.`))}}onToken(e){throw new d(`Can't emit tokens before the "onToken" callback has been set up.`)}onError(e){throw e}onEnd(){}};var R=class{constructor(e={}){s(this,"tokenizer");s(this,"tokenParser");this.tokenizer=new I(e),this.tokenParser=new f(e),this.tokenizer.onToken=this.tokenParser.write.bind(this.tokenParser),this.tokenizer.onEnd=()=>{this.tokenParser.isEnded||this.tokenParser.end()},this.tokenParser.onError=this.tokenizer.error.bind(this.tokenizer),this.tokenParser.onEnd=()=>{this.tokenizer.isEnded||this.tokenizer.end()}}get isEnded(){return this.tokenizer.isEnded&&this.tokenParser.isEnded}write(e){this.tokenizer.write(e)}end(){this.tokenizer.end()}set onToken(e){this.tokenizer.onToken=i=>{let n=[r.STRING,r.NUMBER,r.TRUE,r.FALSE,r.NULL];this.tokenParser.state===0&&n.includes(i.token)&&e({parser:{state:this.tokenParser.state,key:this.tokenParser.key,mode:this.tokenParser.mode,stack:this.tokenParser.stack},tokenizer:i}),this.tokenParser.write(i)}}set onValue(e){this.tokenParser.onValue=e}set onError(e){this.tokenizer.onError=e}set onEnd(e){this.tokenParser.onEnd=()=>{this.tokenizer.isEnded||this.tokenizer.end(),e.call(this.tokenParser)}}};var c=class{constructor(e,i={}){s(this,"schemaInstance");s(this,"activePath",[]);s(this,"completedPaths",[]);s(this,"onKeyComplete");let{defaultData:n,onKeyComplete:t,typeDefaults:o}=i;this.schemaInstance=this.createBlankObject(e,n,o),this.onKeyComplete=t}getDefaultValue(e,i){if(e?._def?.defaultValue)return e._def.defaultValue();switch(e._def.typeName){case"ZodDefault":return e._def.defaultValue();case"ZodString":return i?.hasOwnProperty("string")?i.string:null;case"ZodNumber":return i?.hasOwnProperty("number")?i.number:null;case"ZodBoolean":return i?.hasOwnProperty("boolean")?i.boolean:null;case"ZodArray":return[];case"ZodRecord":return{};case"ZodObject":return this.createBlankObject(e);case"ZodOptional":return this.getDefaultValue(e.unwrap());case"ZodEffects":return this.getDefaultValue(e._def.schema);case"ZodNullable":return null;case"ZodEnum":return null;case"ZodNativeEnum":return null;default:return console.warn(`No explicit default value for type: ${e._def.typeName} - returning null.`),null}}createBlankObject(e,i,n){let t={};for(let o in e.shape){let E=e.shape[o];i&&i?.[o]?t[o]=i?.[o]:t[o]=this.getDefaultValue(E,n)}return t}getPathFromStack(e=[],i){let n=[...e.map(({key:t})=>t),i];return n.shift(),n}handleToken({parser:{key:e,stack:i},tokenizer:{token:n,value:t,partial:o}}){(this.activePath!==this.getPathFromStack(i,e)||this.activePath.length===0)&&(this.activePath=this.getPathFromStack(i,e),!o&&this.completedPaths.push(this.activePath),this.onKeyComplete&&this.onKeyComplete({activePath:this.activePath,completedPaths:this.completedPaths}));try{let E=this.getPathFromStack(i,e),u=U(E);if(o){let m=`${M(u,t)??""}${t}`,k=b(u,m,this.schemaInstance);this.schemaInstance=k}else{let h=b(u,t,this.schemaInstance);this.schemaInstance=h}}catch(E){console.error(`Error in the json parser onToken handler: token ${n} value ${t}`,E)}}getSchemaStub(e,i){return this.createBlankObject(e,i)}parse(e={stringBufferSize:0,handleUnescapedNewLines:!0}){let i=new TextEncoder,n=new R({stringBufferSize:e.stringBufferSize??0,handleUnescapedNewLines:e.handleUnescapedNewLines??!0});return n.onToken=this.handleToken.bind(this),n.onValue=()=>{},new TransformStream({transform:async(o,E)=>{try{if(n.isEnded){E.enqueue(i.encode(JSON.stringify(this.schemaInstance)));return}else n.write(o),E.enqueue(i.encode(JSON.stringify(this.schemaInstance)))}catch(u){console.error("Error in the json parser transform stream: parsing chunk",u,o)}},flush:()=>{this.onKeyComplete&&this.onKeyComplete({completedPaths:this.completedPaths,activePath:[]}),this.activePath=[]}})}};export{c as SchemaStream};
//# sourceMappingURL=index.mjs.map